/*
   For readable source code, check the 'hubs: 
   http://github.com/lachlanhardy/lachstock/blob/master/public/javascripts/g.pie-min.js 
*/

Raphael.fn.g.piechart=function(t,u,k,w,n){n=n||{};var o=this,m=[],r=this.set(),l=this.set(),p=this.set(),g=[],e=w.length,d=0,a=0,b=0,v=9,c=true;l.covers=r;if(e==1){p.push(this.circle(t,u,k).attr({fill:this.g.colors[0],stroke:opt.stroke||"#fff","stroke-width":n.strokewidth==null?1:n.strokewidth}));r.push(this.circle(t,u,k).attr({fill:"#000",opacity:0,"stroke-width":3}));a=w[0];w[0]={value:w[0],order:0,valueOf:function(){return this.value}};p[0].middle={x:t,y:u};p[0].mangle=180}else{function h(H,I,z,F,J,A){var D=Math.PI/180,L=H+z*Math.cos(-F*D),y=H+z*Math.cos(-J*D),G=H+z/2*Math.cos(-(F+(J-F)/2)*D),B=I+z*Math.sin(-F*D),C=I+z*Math.sin(-J*D),K=I+z/2*Math.sin(-(F+(J-F)/2)*D),E=["M",H,I,"L",L,B,"A",z,z,0,+(Math.abs(J-F)>180),1,y,C,"z"];E.middle={x:G,y:K};return E}for(var f=0;f<e;f++){a+=w[f];w[f]={value:w[f],order:f,valueOf:function(){return this.value}}}w.sort(function(y,z){return z.value-y.value});for(var f=0;f<e;f++){if(c&&w[f]*360/a<=1.5){v=f;c=false}if(f>v){c=false;w[v].value+=w[f];w[v].others=true;b=w[v].value}}e=Math.min(v+1,w.length);b&&w.splice(e)&&(w[v].others=true);for(var f=0;f<e;f++){var s=d-360*w[f]/a/2;if(!f){d=90-s;s=d-360*w[f]/a/2}if(n.init){var q=h(t,u,1,d,d-360*w[f]/a).join(",")}var i=h(t,u,k,d,d-=360*w[f]/a);var j=this.path(n.init?q:i).attr({fill:n.colors&&n.colors[f]||this.g.colors[f]||"#666",stroke:n.stroke||"#fff","stroke-width":(n.strokewidth==null?1:n.strokewidth),"stroke-linejoin":"round"});j.value=w[f];j.middle=i.middle;j.mangle=s;m.push(j);p.push(j);n.init&&j.animate({path:i.join(",")},(+n.init-1)||1000,">")}for(var f=0;f<e;f++){var j=o.path(m[f].attr("path")).attr({fill:"#000",opacity:0,"stroke-width":3});n.href&&n.href[f]&&j.attr({href:n.href[f]});j.attr=function(){};r.push(j);p.push(j)}}l.hover=function(y,A){A=A||function(){};var z=this;for(var B=0;B<e;B++){(function(E,D,F){var C={sector:E,cover:D,cx:t,cy:u,mx:E.middle.x,my:E.middle.y,mangle:E.mangle,r:k,value:w[F],total:a,label:z.labels&&z.labels[F]};D.mouseover(function(){y.call(C)}).mouseout(function(){A.call(C)})})(p[B],r[B],B)}return this};l.each=function(y){var z=this;for(var A=0;A<e;A++){(function(E,D,B){var C={sector:E,cover:D,cx:t,cy:u,x:E.middle.x,y:E.middle.y,mangle:E.mangle,r:k,value:w[B],total:a,label:z.labels&&z.labels[B]};y.call(C)})(p[A],r[A],A)}return this};l.click=function(y){var z=this;for(var A=0;A<e;A++){(function(E,D,B){var C={sector:E,cover:D,cx:t,cy:u,mx:E.middle.x,my:E.middle.y,mangle:E.mangle,r:k,value:w[B],total:a,label:z.labels&&z.labels[B]};D.click(function(){y.call(C)})})(p[A],r[A],A)}return this};l.inject=function(y){y.insertBefore(r[0])};var x=function(F,K,y,z){var B=t+k+k/5,C=u,G=C+10;F=F||[];z=(z&&z.toLowerCase&&z.toLowerCase())||"east";y=o.g.markers[y&&y.toLowerCase()]||"disc";l.labels=o.set();for(var H=0;H<e;H++){var A=p[H].attr("fill"),J=w[H].order,I;w[H].others&&(F[J]=K||"Others");F[J]=o.g.labelise(F[J],w[H],a);l.labels.push(o.set());l.labels[H].push(o.g[y](B+5,G,5).attr({fill:A,stroke:"none"}));l.labels[H].push(I=o.text(B+20,G,F[J]||w[J]).attr(o.g.txtattr).attr({fill:n.legendcolor||"#000","text-anchor":"start"}));r[H].label=l.labels[H];G+=I.getBBox().height*1.2}var E=l.labels.getBBox(),D={east:[0,-E.height/2],west:[-E.width-2*k-20,-E.height/2],north:[-k-E.width/2,-k-E.height-10],south:[-k-E.width/2,k+10]}[z];l.labels.translate.apply(l.labels,D);l.push(l.labels)};if(n.legend){x(n.legend,n.legendothers,n.legendmark,n.legendpos)}l.push(p,r);l.series=p;l.covers=r;return l};